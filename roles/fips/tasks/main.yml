---
# tasks file for enabling fips on a RHEL-8 Server

- name: Check for supported version
  fail:
    msg: "FIPS is currently only supported on RHEL-8, detected: {{ ansible_distribution }}"
  when: ansible_os_family != 'RedHat' or ansible_distribution_major_version != "8"

- name: Find java-1.8-openjdk directory
  find:
    paths: /etc/java/java-1.8.0-openjdk
    patterns: "java-1.8.0-openjdk-1.8.0*"
    file_type: "directory"
  register: java_path

- name: Get Java 8 directory path
  set_fact:
    java8_dir_path: "{{ java_path.files | map(attribute='path') | first }}"

- name: Setup the fips providers in java.security
  copy:
    src: java.security
    dest: "{{ java8_dir_path }}/lib/security/java.security"
    owner: root
    group: root
    mode: '0644'
    backup: yes

- name: Place bouncy castle libraries in the classpath  [JRE] [1 of 2]
  copy:
    src: bc-fips-1.0.2.3.jar
    dest: /usr/lib/jvm/jre/lib/ext/bc-fips-1.0.2.3.jar
    owner: root
    group: root
    mode: '0644'

- name: Place bouncy castle libraries in the classpath  [JRE] [2 of 2]
  copy:
    src: bcpkix-fips-1.0.7.jar
    dest: /usr/lib/jvm/jre/lib/ext/bcpkix-fips-1.0.6.jar
    owner: root
    group: root
    mode: '0644'

- name: Check if FIPS is enabled
  shell: cat /proc/sys/crypto/fips_enabled
  register: fips_enabled_output
  changed_when: false

- name: Set fact of FIPS enabled status
  set_fact:
    fips_sysctl_enabled: "{{ fips_enabled_output.stdout == '1' }}"

- name: Report the FIPS status
  debug:
    msg: "fips_sysctl_enable : {{ fips_sysctl_enabled }} "

- name: Report that we are enabling FIPS
  debug:
    msg: "Enabling FIPS because it has not been enabled yet"
  when: not fips_sysctl_enabled

- name: Report that we are skipping FIPS steps
  debug:
    msg: "Skipping FIPS setup because it is already enabled"
  when: fips_sysctl_enabled

- name: Install dracut-fips
  yum:
    name: dracut-fips
    state: present
  when: not fips_sysctl_enabled

- name: Checking for AES-NI
  raw: cat /proc/cpuinfo
  register: cpu_contents
  changed_when: cpu_contents.rc != 0

- name: Installing dracut-fips-aesni if AES support is found
  yum:
    name: dracut-fips-aesni
    state: present
  when: cpu_contents.stdout.find('aes') != -1 and (not fips_sysctl_enabled)

- name: Enabling FIPS
  raw: fips-mode-setup --enable
  register: fips_setup_output
  when: not fips_sysctl_enabled

- name: Report the fips-setup output
  debug:
    msg: "fips_setup: {{ fips_setup_output }}"
  when: not fips_sysctl_enabled

- name: Inform of need to reboot
  debug:
    msg: "WARNING: A system reboot is required to finalize enabling FIPS"
  when: not fips_sysctl_enabled