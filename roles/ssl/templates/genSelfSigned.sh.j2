#!/bin/bash

{% if use_self_signed %}

CN=`openssl x509 -noout -subject -in /etc/ssl/certs/{{ ssl_certificate }}  | sed -n '/^subject/s/^.*CN=//p'`
SERVERNAME="{{ ServerName }}"

if [[ $CN != $SERVERNAME ]]
 then
	openssl req -new -nodes -x509 -subj "/C=US/ST=Tennessee/L=Franklin/O=IT/CN={{ ServerName }}" -days 3650 -keyout "/etc/ssl/private/{{ ssl_key }}" -out "/etc/ssl/certs/{{ ssl_certificate }}" -extensions v3_ca
fi

{% else %}

echo "The var use_self_signed is false, so I am not generating a certificate."

{% endif %}

# Remove the existing cert if it is in the keystore
{{ java_home }}/bin/keytool -delete -noprompt -alias {{ ServerName }} -keystore {{ java_home }}/jre/lib/security/cacerts -storepass changeit

# Insert the new certificate
{{ java_home }}/bin/keytool -import -trustcacerts -alias {{ ServerName }} -file /etc/ssl/certs/{{ ssl_certificate }} -keystore {{ java_home }}/jre/lib/security/cacerts -noprompt -storepass changeit
